<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f7f9fc">
    <title>åŸé»é›²æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --primary-color: #00bfa5; 
            --primary-light: #e0f2f1;
            --secondary-color: #ff8f00; 
            --secondary-light: #fff8e1;
            --bg-color: #f7f9fc; 
            --card-bg: #ffffff; 
            --text-main: #2c3e50;
            --text-dim: #7f8c8d;
            --error-color: #e74c3c;
            --shadow: 0 12px 30px rgba(0,0,0,0.06);
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background: var(--bg-color); 
            color: var(--text-main); 
        }

        .card { 
            background: var(--card-bg); 
            padding: 35px 25px; 
            border-radius: 32px; 
            box-shadow: var(--shadow); 
            text-align: center; 
            width: 90%; 
            max-width: 440px; 
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            overflow: hidden;
        }

        .brand { 
            font-size: 26px; 
            font-weight: 800; 
            margin-bottom: 8px; 
            letter-spacing: 4px; 
            color: var(--primary-color);
            text-transform: uppercase;
        }
        
        .admin-active .brand { display: none; }
        .admin-active .card { padding-top: 20px; border: 1px solid var(--primary-light); }

        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary-color); 
            border-radius: 50%; 
            width: 45px; 
            height: 45px; 
            animation: spin 1s linear infinite; 
            margin: 30px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button-group {
            display: none;
            flex-direction: column;
            gap: 18px;
            margin: 20px 0 30px 0;
        }

        /* GPS ä½ç½®é¡¯ç¤ºæ¨£å¼ */
        .location-badge {
            display: none;
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            margin: 10px auto;
            border: 1px solid rgba(0, 191, 165, 0.2);
            width: fit-content;
        }

        .btn {
            padding: 16px;
            border-radius: 18px;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 191, 165, 0.25);
            outline: none;
        }

        .btn:active { transform: scale(0.96); box-shadow: 0 2px 8px rgba(0, 191, 165, 0.2); }

        .btn-out {
            background: #ffffff;
            color: var(--text-dim);
            border: 1.5px solid #dcdde1;
            box-shadow: none;
        }

        .btn-history {
            border: none;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            background: none;
            margin-top: 15px;
            cursor: pointer;
            display: inline-block;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
            margin-top: 10px;
        }
        .history-list::-webkit-scrollbar { width: 4px; }
        .history-list::-webkit-scrollbar-thumb { background: #eee; border-radius: 10px; }

        .history-item {
            background: #ffffff;
            padding: 16px;
            border-radius: 20px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #f1f4f8;
            box-shadow: 0 4px 10px rgba(0,0,0,0.01);
        }
        
        .history-item.in { border-left: 6px solid var(--primary-color); background: var(--primary-light); }
        .history-item.out { border-left: 6px solid var(--secondary-color); background: var(--secondary-light); }

        .daily-summary {
            background: #ffffff;
            border: 1.5px dashed var(--primary-color);
            padding: 12px 18px;
            border-radius: 16px;
            margin: 5px 0 20px 0;
            font-size: 13px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
        }

        .item-info { display: flex; flex-direction: column; text-align: left; }
        .item-type { font-size: 14px; font-weight: 800; color: #2d3436; }
        .item-date { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
        .item-time { font-size: 18px; font-weight: 900; color: #2d3436; }
        .item-user { font-size: 12px; color: var(--primary-color); margin-bottom: 4px; font-weight: bold; }

        .btn-delete {
            font-size: 10px;
            color: var(--error-color);
            background: #fff;
            border: 1px solid var(--error-color);
            padding: 3px 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-weight: bold;
        }

        .admin-header-ui {
            background: linear-gradient(135deg, var(--primary-color), #00d2ff);
            margin: -20px -25px 20px -25px;
            padding: 25px;
            color: white;
            text-align: left;
        }
        .admin-header-ui h2 { margin: 0; font-size: 20px; letter-spacing: 1px; }

        .controls-box {
            background: #f8fafc;
            padding: 20px;
            border-radius: 24px;
            margin-bottom: 20px;
            border: 1px solid #edf2f7;
        }
        
        .admin-select, .admin-input {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            margin-top: 8px;
            font-size: 14px;
            background: white;
            font-weight: 600;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .stats-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px 10px;
            border-radius: 16px;
            text-align: center;
            border: 1px solid #f1f5f9;
        }
        .stat-card span { display: block; font-size: 10px; color: var(--text-dim); font-weight: bold; }
        .stat-card b { font-size: 20px; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            width: 85%;
            max-width: 320px;
            text-align: center;
        }
        .modal-btns { display: flex; gap: 12px; margin-top: 25px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }
        .btn-confirm { background: var(--error-color); color: white; }
        .btn-cancel { background: #f1f5f9; color: #64748b; }

        #status { 
            font-size: 14px; 
            color: var(--text-dim); 
            margin-top: 15px; 
            line-height: 1.6;
            font-weight: 500;
        }
        .version {
            margin-top: 30px;
            font-size: 11px;
            color: #bdc3c7;
            letter-spacing: 2px;
            font-weight: bold;
        }
        .admin-link {
            position: absolute;
            bottom: 12px;
            right: 25px;
            font-size: 10px;
            color: rgba(0,0,0,0.03);
            cursor: pointer;
            padding: 15px;
        }
        .retry-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
            display: none;
        }
    </style>
</head>
<body>
    <div id="main-card" class="card">
        <div class="brand">åŸé»é›²</div>
        
        <!-- é¦–é ï¼šæ‰“å¡å€ -->
        <div id="clock-page">
            <div id="loader" class="loader"></div>
            
            <!-- æ–°å¢ï¼šGPS ä½ç½®é¡¯ç¤ºå€ -->
            <div id="gps-display" class="location-badge">è®€å–åº§æ¨™ä¸­...</div>

            <div id="btn-container" class="button-group">
                <button class="btn" onclick="submitCheckIn('ç°½åˆ°')">ç°½åˆ°ä¸Šç­</button>
                <button class="btn btn-out" onclick="submitCheckIn('ç°½é€€')">ç°½é€€ä¸‹ç­</button>
            </div>
            <div id="success" class="success-icon">âœ”</div>
            <button id="nav-history-btn" class="btn-history" onclick="showView('history')">æŸ¥çœ‹æˆ‘çš„ç´€éŒ„</button>
        </div>

        <!-- åˆ†é ï¼šå€‹äººç´€éŒ„å€ -->
        <div id="history-page" style="display:none;">
            <div class="history-header">
                <h3 style="margin: 0; font-size: 18px;">è€ƒå‹¤ç´€éŒ„</h3>
                <span style="font-size: 12px; color: var(--text-dim);">å€‹äººå°ˆå€</span>
            </div>
            <div class="controls-box" style="padding: 15px;">
                <div class="stats-box" style="margin-top: 0;">
                    <div class="stat-card"><span>ç°½åˆ°</span><b id="user-stat-in">0</b></div>
                    <div class="stat-card"><span>ç°½é€€</span><b id="user-stat-out">0</b></div>
                </div>
            </div>
            <div id="history-list" class="history-list">
                <p style="text-align: center; color: #bdc3c7; font-size: 14px;">è³‡æ–™åŠ è¼‰ä¸­...</p>
            </div>
            <button class="btn-history" style="width: 100%; margin-top: 25px; text-align: center; font-weight: 800;" onclick="showView('clock')">â† è¿”å›ä¸»é </button>
        </div>

        <!-- åˆ†é ï¼šç®¡ç†å“¡æŸ¥è©¢å€ -->
        <div id="admin-page" style="display:none;">
            <div class="admin-header-ui">
                <h2>ç®¡ç†æ§åˆ¶å°</h2>
                <div id="admin-tabs" class="admin-tabs" style="margin-top: 15px;">
                    <button id="tab-records" class="tab-btn active" onclick="switchAdminTab('records')">å‡ºå‹¤æ˜ç´°</button>
                    <button id="tab-settings" class="tab-btn" onclick="switchAdminTab('settings')">åœ°é»è¨­å®š</button>
                </div>
            </div>
            
            <div id="admin-tab-records-content">
                <div class="controls-box">
                    <label style="font-size: 12px; font-weight: bold; color: var(--text-dim); padding-left: 4px;">äººå“¡ç¯©é¸</label>
                    <select id="user-filter" class="admin-select" onchange="filterAdminHistory()">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰äºº</option>
                    </select>
                    <div class="stats-box">
                        <div class="stat-card"><span>ç°½åˆ°ç´¯è¨ˆ</span><b id="stat-in">0</b></div>
                        <div class="stat-card"><span>ç°½é€€ç´¯è¨ˆ</span><b id="stat-out">0</b></div>
                    </div>
                </div>
                <div id="admin-list" class="history-list">
                    <p style="text-align: center; color: #bdc3c7; font-size: 14px;">å¤§æ•¸æ“šåˆ†æä¸­...</p>
                </div>
            </div>

            <div id="admin-tab-settings-content" style="display:none;">
                <div class="controls-box" style="text-align: left;">
                    <p style="font-size: 11px; color: var(--secondary-color); margin-bottom: 15px;">* è¨­å®šå¾Œå“¡å·¥åƒ…èƒ½åœ¨æŒ‡å®šè·é›¢å…§æ‰“å¡</p>
                    
                    <label style="font-size: 12px; font-weight: bold;">è¾¦å…¬åœ°é»ç·¯åº¦ (Lat)</label>
                    <input type="number" id="set-lat" class="admin-input" step="any" placeholder="ä¾‹å¦‚: 25.0330">
                    
                    <label style="font-size: 12px; font-weight: bold; margin-top: 10px; display: block;">è¾¦å…¬åœ°é»ç¶“åº¦ (Lng)</label>
                    <input type="number" id="set-lng" class="admin-input" step="any" placeholder="ä¾‹å¦‚: 121.5654">
                    
                    <label style="font-size: 12px; font-weight: bold; margin-top: 10px; display: block;">å®¹è¨±èª¤å·®è·é›¢ (å…¬å°º)</label>
                    <input type="number" id="set-radius" class="admin-input" placeholder="å»ºè­°è¨­å®š 200">

                    <button class="btn" style="width: 100%; margin-top: 20px; font-size: 14px;" onclick="captureCurrentLocation()">ä½¿ç”¨æˆ‘ç•¶å‰ä½ç½®</button>
                    <button class="btn" style="width: 100%; margin-top: 10px; font-size: 14px; background: var(--secondary-color);" onclick="saveOfficeSettings()">å„²å­˜åœ°é»è¨­å®š</button>
                </div>
            </div>

            <button class="btn-history" style="width: 100%; margin-top: 25px; text-align: center; font-weight: 800;" onclick="showView('clock')">ç™»å‡ºç®¡ç†æ¨¡å¼</button>
        </div>
        
        <p id="status">ç³»çµ±åˆå§‹åŒ–...</p>
        <button id="retry-btn" class="retry-btn" onclick="location.reload()">é‡æ–°é€£ç·š</button>
        <div class="version">ORIGIN CLOUD V2.7 PRO</div>
        <div id="admin-entrance" class="admin-link" onclick="openAdminLoginModal()">ADMIN</div>
    </div>

    <!-- ç®¡ç†å“¡ç™»å…¥å½ˆçª— -->
    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--primary-color);">ç®¡ç†å“¡é©—è­‰</h3>
            <p style="font-size:14px; color:#64748b; margin-bottom:15px;">è«‹è¼¸å…¥å¾Œå°è¨ªå•å¯†ç¢¼</p>
            <input type="password" id="admin-password-input" class="admin-select" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align:center; margin-bottom:15px; border-style: solid;">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeAdminLoginModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" style="background:var(--primary-color);" onclick="verifyAdminPassword()">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <!-- è¨»éŠ·ç¢ºèªå½ˆçª— -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--error-color); font-size: 20px;">è¨»éŠ·æ‰“å¡ï¼Ÿ</h3>
            <p style="font-size:14px; color:#64748b; line-height: 1.5;">è©²æ“ä½œå°‡å¾è³‡æ–™åº«ä¸­æ°¸ä¹…ç§»é™¤æ­¤ç´€éŒ„ã€‚</p>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="modal-btn btn-confirm">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1CUSE-tou-H_BxfEGg4mxA30HsGF8DWE",
            authDomain: "origin-cloud-clockin.firebaseapp.com",
            projectId: "origin-cloud-clockin",
            storageBucket: "origin-cloud-clockin.firebasestorage.app",
            messagingSenderId: "160594589221",
            appId: "1:160594589221:web:29aad0f9cbeb828d7571cc",
            measurementId: "G-EC0ZQZ47E0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userProfile = null;
        let userCoords = null;
        let allRecords = []; 
        let pendingDeleteId = null;
        let officeSettings = null;

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        window.showView = function(view) {
            const clockPage = document.getElementById('clock-page');
            const historyPage = document.getElementById('history-page');
            const adminPage = document.getElementById('admin-page');
            const status = document.getElementById('status');
            const mainCard = document.getElementById('main-card');
            const adminEntrance = document.getElementById('admin-entrance');

            clockPage.style.display = 'none';
            historyPage.style.display = 'none';
            adminPage.style.display = 'none';
            mainCard.classList.remove('admin-active');
            adminEntrance.style.display = 'block';

            if (view === 'history') {
                historyPage.style.display = 'block';
                status.style.display = 'none';
                fetchHistory();
            } else if (view === 'admin') {
                adminPage.style.display = 'block';
                status.style.display = 'none';
                mainCard.classList.add('admin-active');
                adminEntrance.style.display = 'none'; 
                switchAdminTab('records');
            } else {
                clockPage.style.display = 'block';
                status.style.display = 'block';
                status.innerText = userCoords ? "å®šä½æˆåŠŸï¼Œå¯é–‹å§‹æ‰“å¡" : "ç³»çµ±é€£ç·šä¸­...";
            }
        };

        window.switchAdminTab = function(tab) {
            const recordsContent = document.getElementById('admin-tab-records-content');
            const settingsContent = document.getElementById('admin-tab-settings-content');
            const tabRec = document.getElementById('tab-records');
            const tabSet = document.getElementById('tab-settings');
            if (tab === 'records') {
                recordsContent.style.display = 'block';
                settingsContent.style.display = 'none';
                tabRec.classList.add('active');
                tabSet.classList.remove('active');
                fetchAdminHistory();
            } else {
                recordsContent.style.display = 'none';
                settingsContent.style.display = 'block';
                tabRec.classList.remove('active');
                tabSet.classList.add('active');
                loadOfficeSettingsUI();
            }
        };

        window.openAdminLoginModal = function() {
            document.getElementById('admin-password-input').value = '';
            document.getElementById('admin-login-modal').style.display = 'flex';
        };

        window.closeAdminLoginModal = function() {
            document.getElementById('admin-login-modal').style.display = 'none';
        };

        window.verifyAdminPassword = function() {
            const pw = document.getElementById('admin-password-input').value;
            if (pw === "1016") {
                closeAdminLoginModal();
                showView('admin');
            } else {
                alert("å¯†ç¢¼éŒ¯èª¤");
                closeAdminLoginModal();
            }
        };

        async function loadOfficeSettingsUI() {
            if (officeSettings) {
                document.getElementById('set-lat').value = officeSettings.lat;
                document.getElementById('set-lng').value = officeSettings.lng;
                document.getElementById('set-radius').value = officeSettings.radius;
            }
        }

        window.captureCurrentLocation = function() {
            if (userCoords) {
                document.getElementById('set-lat').value = userCoords.lat;
                document.getElementById('set-lng').value = userCoords.lng;
                document.getElementById('set-radius').value = 200;
                alert("å·²æŠ“å–æ‚¨çš„ç•¶å‰ä½ç½®ä½œç‚ºåŸºæº–");
            } else { alert("å°šæœªå–å¾—æ‚¨çš„å®šä½ï¼Œè«‹ç¨å€™"); }
        };

        window.saveOfficeSettings = async function() {
            const lat = parseFloat(document.getElementById('set-lat').value);
            const lng = parseFloat(document.getElementById('set-lng').value);
            const radius = parseInt(document.getElementById('set-radius').value);
            if (isNaN(lat) || isNaN(lng) || isNaN(radius)) { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—"); return; }
            try {
                await setDoc(doc(db, "tenants/Corin_Beauty/settings", "location"), {
                    lat, lng, radius, updatedAt: serverTimestamp()
                });
                officeSettings = { lat, lng, radius };
                alert("è¨­å®šå„²å­˜æˆåŠŸï¼");
            } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
        };

        window.openDeleteModal = function(id) { pendingDeleteId = id; document.getElementById('delete-modal').style.display = 'flex'; };
        window.closeDeleteModal = function() { pendingDeleteId = null; document.getElementById('delete-modal').style.display = 'none'; };

        document.getElementById('modal-confirm-btn').onclick = async function() {
            if (!pendingDeleteId) return;
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                await deleteDoc(doc(db, "tenants/Corin_Beauty/checkins", pendingDeleteId));
                closeDeleteModal();
                fetchHistory();
            } catch (e) { console.error("è¨»éŠ·å¤±æ•—"); }
        };

        async function initSystem() {
            const statusText = document.getElementById('status');
            const gpsDisplay = document.getElementById('gps-display');
            try {
                showView('clock');
                statusText.innerText = "æ­£åœ¨é€£ç·š LINE...";
                await liff.init({ liffId: "2008997688-9iB69K6M" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile();
                await signInAnonymously(auth);
                
                const settingsSnap = await getDoc(doc(db, "tenants/Corin_Beauty/settings", "location"));
                if (settingsSnap.exists()) officeSettings = settingsSnap.data();

                statusText.innerText = "æ­£åœ¨ç²å–å®šä½...";
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    
                    // æ›´æ–°ç•«é¢ä¸Šé¡¯ç¤ºçš„åº§æ¨™
                    gpsDisplay.style.display = "block";
                    gpsDisplay.innerText = `ğŸ“ ç›®å‰ä½ç½®: ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)}`;

                    document.getElementById('loader').style.display = "none";
                    document.getElementById('btn-container').style.display = "flex";
                    statusText.innerText = "å®šä½æˆåŠŸï¼Œå¯é–‹å§‹æ‰“å¡";
                }, (err) => {
                    document.getElementById('loader').style.display = "none";
                    statusText.innerText = "å®šä½å¤±æ•—: è«‹é–‹å•Ÿæ‰‹æ©Ÿ GPS";
                    statusText.style.color = "var(--error-color)";
                    document.getElementById('retry-btn').style.display = "inline-block";
                }, { enableHighAccuracy: true, timeout: 10000 });
            } catch (err) {
                statusText.innerText = "ç³»çµ±é€£ç·šä¸­æ–·";
                console.error(err);
            }
        }

        window.submitCheckIn = async function(type) {
            if (!userProfile || !userCoords) return;
            
            if (officeSettings) {
                const dist = getDistance(userCoords.lat, userCoords.lng, officeSettings.lat, officeSettings.lng);
                if (dist > officeSettings.radius) {
                    const statusText = document.getElementById('status');
                    statusText.innerText = `è·é›¢è¾¦å…¬é»éé  (${Math.round(dist)}m)\næ‰“å¡å¤±æ•—ï¼Œè«‹é è¿‘å¾Œå†è©¦`;
                    statusText.style.color = "var(--error-color)";
                    return;
                }
            }

            document.getElementById('btn-container').style.display = "none";
            document.getElementById('gps-display').style.display = "none";
            document.getElementById('loader').style.display = "block";
            document.getElementById('status').innerText = `æ­£åœ¨æäº¤${type}...`;

            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                if (!auth.currentUser) await signInAnonymously(auth);
                await addDoc(collection(db, "tenants/Corin_Beauty/checkins"), {
                    userId: userProfile.userId,
                    userName: userProfile.displayName,
                    lat: userCoords.lat,
                    lng: userCoords.lng,
                    timestamp: serverTimestamp(),
                    type: type,
                    client: "Origin-Cloud-V2.7"
                });
                document.getElementById('loader').style.display = "none";
                document.getElementById('success').style.display = "block";
                document.getElementById('status').innerText = `[${timeStr}] ${type}æˆåŠŸï¼`;
                setTimeout(() => liff.closeWindow(), 2500);
            } catch (e) { document.getElementById('status').innerText = "æäº¤å¤±æ•—: " + e.message; }
        };

        async function fetchHistory() {
            const listContainer = document.getElementById('history-list');
            try {
                const querySnapshot = await getDocs(collection(db, "tenants/Corin_Beauty/checkins"));
                let records = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.userId === userProfile.userId) records.push({ ...data, id: doc.id });
                });
                document.getElementById('user-stat-in').textContent = records.filter(r => r.type === 'ç°½åˆ°').length;
                document.getElementById('user-stat-out').textContent = records.filter(r => r.type === 'ç°½é€€').length;
                renderHistoryList(records, listContainer, false);
            } catch (e) { listContainer.innerHTML = '<p>è®€å–å¤±æ•—</p>'; }
        }

        async function fetchAdminHistory() {
            const listContainer = document.getElementById('admin-list');
            const filterSelect = document.getElementById('user-filter');
            try {
                const querySnapshot = await getDocs(collection(db, "tenants/Corin_Beauty/checkins"));
                allRecords = [];
                let users = new Set();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allRecords.push({ ...data, id: doc.id });
                    if (data.userName) users.add(data.userName);
                });
                filterSelect.innerHTML = '<option value="all">é¡¯ç¤ºæ‰€æœ‰äºº</option>';
                Array.from(users).sort().forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name; opt.textContent = name;
                    filterSelect.appendChild(opt);
                });
                filterAdminHistory();
            } catch (e) { listContainer.innerHTML = '<p>åŠ è¼‰å¤±æ•—</p>'; }
        }

        window.filterAdminHistory = function() {
            const listContainer = document.getElementById('admin-list');
            const filterValue = document.getElementById('user-filter').value;
            let filtered = filterValue === "all" ? allRecords : allRecords.filter(r => r.userName === filterValue);
            document.getElementById('stat-in').textContent = filtered.filter(r => r.type === 'ç°½åˆ°').length;
            document.getElementById('stat-out').textContent = filtered.filter(r => r.type === 'ç°½é€€').length;
            renderHistoryList(filtered, listContainer, true);
        };

        function renderHistoryList(records, container, isAdminView) {
            let groups = {};
            records.forEach(rec => {
                if (!rec.timestamp) return;
                const d = rec.timestamp.toDate();
                const dateKey = d.toLocaleDateString('zh-TW');
                const userKey = rec.userName || 'æœªçŸ¥ç”¨æˆ¶';
                const key = `${dateKey}_${userKey}`;
                if (!groups[key]) groups[key] = { date: dateKey, user: userKey, items: [], totalMinutes: 0 };
                groups[key].items.push(rec);
            });
            Object.values(groups).forEach(group => {
                const ins = group.items.filter(i => i.type === 'ç°½åˆ°');
                const outs = group.items.filter(i => i.type === 'ç°½é€€');
                if (ins.length && outs.length) {
                    const firstIn = Math.min(...ins.map(i => i.timestamp.toDate()));
                    const lastOut = Math.max(...outs.map(i => i.timestamp.toDate()));
                    if (lastOut > firstIn) group.totalMinutes = (lastOut - firstIn) / (1000 * 60);
                }
            });
            const sortedGroups = Object.values(groups).sort((a, b) => new Date(b.date.replace(/\//g,'-')) - new Date(a.date.replace(/\//g,'-')));
            if (!sortedGroups.length) { container.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">å°šç„¡æ•¸æ“š</p>'; return; }
            container.innerHTML = sortedGroups.map(group => {
                const itemsHtml = group.items.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds).map(rec => {
                    const timeStr = rec.timestamp.toDate().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
                    return `
                        <div class="history-item ${rec.type === 'ç°½åˆ°' ? 'in' : 'out'}">
                            <div class="item-info">
                                ${isAdminView ? `<span class="item-user">${rec.userName}</span>` : ''}
                                <span class="item-type">${rec.type}</span>
                                <span class="item-date">${group.date}</span>
                                ${!isAdminView ? `<button class="btn-delete" onclick="openDeleteModal('${rec.id}')">è¨»éŠ·</button>` : ''}
                            </div>
                            <div class="item-time">${timeStr}</div>
                        </div>
                    `;
                }).join('');
                const durationHtml = group.totalMinutes > 0 ? `<div class="daily-summary"><span>ğŸ•’ å–®æ—¥ç¸½å·¥æ™‚</span><span>${Math.floor(group.totalMinutes/60)} å°æ™‚ ${Math.round(group.totalMinutes%60)} åˆ†</span></div>` : '';
                return itemsHtml + durationHtml;
            }).join('');
        }

        window.onload = initSystem;
    </script>
</body>
</html>
