<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f7f9fc">
    <title>åŸé»é›²æ‰“å¡ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { 
            --primary-color: #00bfa5; 
            --primary-light: #e0f2f1;
            --secondary-color: #ff8f00; 
            --secondary-light: #fff8e1;
            --bg-color: #f7f9fc; 
            --card-bg: #ffffff; 
            --text-main: #2c3e50;
            --text-dim: #7f8c8d;
            --error-color: #e74c3c;
            --shadow: 0 12px 30px rgba(0,0,0,0.06);
        }
        
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background: var(--bg-color); 
            color: var(--text-main); 
        }

        .card { 
            background: var(--card-bg); 
            padding: 30px 20px; 
            border-radius: 32px; 
            box-shadow: var(--shadow); 
            text-align: center; 
            width: 92%; 
            max-width: 440px; 
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            position: relative;
            overflow: hidden;
        }

        .brand { 
            font-size: 24px; 
            font-weight: 800; 
            margin-bottom: 5px; 
            letter-spacing: 4px; 
            color: var(--primary-color);
            text-transform: uppercase;
        }
        
        .admin-active .brand { display: none; }
        .admin-active .card { padding-top: 20px; }

        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid var(--primary-color); 
            border-radius: 50%; 
            width: 45px; 
            height: 45px; 
            animation: spin 1s linear infinite; 
            margin: 30px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .button-group {
            display: none;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0 20px 0;
        }

        .main-map-container {
            width: 100%;
            height: 250px; 
            background: #eee;
            border-radius: 20px;
            overflow: hidden;
            margin: 10px 0 15px 0;
            display: none;
            border: 1px solid #edf2f7;
        }
        .main-map-container iframe { width: 100%; height: 100%; border: none; }

        .location-badge {
            display: none;
            background: var(--primary-light);
            color: var(--primary-color);
            padding: 8px 14px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 800;
            margin: 0 auto 10px auto;
            border: 1px solid rgba(0, 191, 165, 0.1);
            width: fit-content;
        }

        .btn {
            padding: 16px;
            border-radius: 18px;
            border: none;
            background: var(--primary-color);
            color: white;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 191, 165, 0.2);
            outline: none;
        }
        .btn:active { transform: scale(0.96); }

        .btn-out { background: #ffffff; color: var(--text-dim); border: 1.5px solid #dcdde1; box-shadow: none; }

        .btn-history {
            border: none;
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
            background: none;
            margin-top: 10px;
            cursor: pointer;
        }

        .history-list {
            max-height: 380px;
            overflow-y: auto;
            padding-right: 4px;
            margin-top: 10px;
        }
        .history-list::-webkit-scrollbar { width: 4px; }
        .history-list::-webkit-scrollbar-thumb { background: #eee; border-radius: 10px; }

        /* ç´€éŒ„å¡ç‰‡ä½ˆå±€ä¿®æ­£ï¼šç¢ºä¿ç‚ºç›´å‘ */
        .history-item {
            background: #ffffff;
            padding: 15px;
            border-radius: 20px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
            border: 1px solid #f1f4f8;
            box-shadow: 0 4px 10px rgba(0,0,0,0.01);
            position: relative;
        }
        
        .history-item.in { border-left: 6px solid var(--primary-color); background: var(--primary-light); }
        .history-item.out { border-left: 6px solid var(--secondary-color); background: var(--secondary-light); }

        .daily-summary {
            background: #ffffff;
            border: 1.5px dashed var(--primary-color);
            padding: 12px 18px;
            border-radius: 16px;
            margin: 5px 0 20px 0;
            font-size: 13px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 800;
        }

        .item-info { display: flex; flex-direction: column; text-align: left; width: 100%; }
        .item-type { font-size: 14px; font-weight: 800; color: #2d3436; }
        .item-date { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
        
        .item-time-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            width: 100%;
            margin-top: 10px;
        }
        .item-time { font-size: 20px; font-weight: 900; color: #2d3436; }

        .item-loc-name {
            font-size: 10px;
            color: var(--primary-color);
            font-weight: 800;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .btn-delete {
            font-size: 10px;
            color: var(--error-color);
            background: #fff;
            border: 1px solid var(--error-color);
            padding: 4px 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-delete:active { background: var(--error-color); color: #fff; }

        .admin-header-ui {
            background: linear-gradient(135deg, var(--primary-color), #00d2ff);
            margin: -20px -25px 20px -25px;
            padding: 20px;
            color: white;
            text-align: left;
        }
        .admin-header-ui h2 { margin: 0; font-size: 20px; letter-spacing: 1px; }

        .admin-tabs { display: flex; gap: 8px; margin-top: 15px; }
        .tab-btn {
            flex: 1; padding: 10px; font-size: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.15); color: white; cursor: pointer; font-weight: bold;
        }
        .tab-btn.active { background: white; color: var(--primary-color); border-color: white; }

        .controls-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 24px;
            margin-bottom: 20px;
            border: 1px solid #edf2f7;
        }
        
        .admin-input {
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; margin-top: 8px;
            font-size: 13px; background: white; font-weight: 600; outline: none;
        }

        .location-manager-list { margin-top: 15px; text-align: left; }
        .location-card {
            background: #ffffff; 
            padding: 16px; 
            border-radius: 20px; 
            margin-bottom: 12px;
            border: 1px solid #f1f4f8; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-left: 6px solid var(--primary-color); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.01);
        }
        .loc-info { display: flex; flex-direction: column; gap: 4px; }
        .loc-name { font-size: 15px; font-weight: 800; color: var(--text-main); }
        .loc-detail { font-size: 10px; color: var(--text-dim); letter-spacing: 0.5px; }
        .loc-radius-pill { 
            font-size: 9px; 
            background: var(--primary-light); 
            color: var(--primary-color); 
            padding: 2px 8px; 
            border-radius: 100px; 
            width: fit-content;
            font-weight: 700;
            margin-top: 2px;
        }
        .btn-loc-del { 
            color: var(--error-color); 
            font-size: 11px; 
            cursor: pointer; 
            padding: 6px 12px; 
            font-weight: 800; 
            background: #fff0f0;
            border-radius: 10px;
            transition: 0.2s;
        }
        .btn-loc-del:active { transform: scale(0.9); background: var(--error-color); color: #fff; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center;
            z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 28px; width: 90%; max-width: 380px; text-align: center;
        }

        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 14px; border: none; font-weight: bold; cursor: pointer; }

        #status { font-size: 13px; color: var(--text-dim); margin-top: 10px; line-height: 1.6; white-space: pre-line; }
        .version { margin-top: 20px; font-size: 10px; color: #bdc3c7; letter-spacing: 1px; font-weight: bold; }
        .admin-link { position: absolute; bottom: 10px; right: 20px; font-size: 10px; color: rgba(0,0,0,0.03); cursor: pointer; padding: 10px; }
        
        .admin-map-preview {
            width: 100%;
            height: 180px;
            background: #eee;
            border-radius: 15px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
            border: 1px solid #e2e8f0;
        }
        .admin-map-preview iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>
    <div id="main-card" class="card">
        <div class="brand">åŸé»é›²</div>
        
        <!-- æ‰“å¡é¦–é  -->
        <div id="clock-page">
            <div id="loader" class="loader"></div>
            
            <div id="status">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
            <div id="gps-display" class="location-badge">è®€å–åº§æ¨™ä¸­...</div>

            <!-- é¦–é å…§å´åœ°åœ– -->
            <div id="main-map-box" class="main-map-container">
                <iframe id="main-map-iframe" src=""></iframe>
            </div>

            <div id="btn-container" class="button-group">
                <button class="btn" onclick="submitCheckIn('ç°½åˆ°')">ç°½åˆ°ä¸Šç­</button>
                <button class="btn btn-out" onclick="submitCheckIn('ç°½é€€')">ç°½é€€ä¸‹ç­</button>
            </div>
            <div id="success" class="success-icon">âœ”</div>
            <button id="nav-history-btn" class="btn-history" onclick="showView('history')">æŸ¥çœ‹æˆ‘çš„ç´€éŒ„</button>
        </div>

        <!-- å€‹äººç´€éŒ„åˆ†é  -->
        <div id="history-page" style="display:none;">
            <div class="history-header">
                <h3 style="margin: 0; font-size: 18px;">è€ƒå‹¤ç´€éŒ„</h3>
                <span style="font-size: 12px; color: var(--text-dim);">å€‹äººè€ƒå‹¤å°ˆå€</span>
            </div>
            <div id="history-list" class="history-list">
                <p style="text-align: center; color: #bdc3c7; font-size: 14px;">è³‡æ–™è¼‰å…¥ä¸­...</p>
            </div>
            <button class="btn-history" style="width: 100%; margin-top: 25px; text-align: center; font-weight: 800;" onclick="showView('clock')">â† è¿”å›ä¸»é </button>
        </div>

        <!-- ç®¡ç†å¾Œå°åˆ†é  -->
        <div id="admin-page" style="display:none;">
            <div class="admin-header-ui">
                <h2>ç®¡ç†æ§åˆ¶å°</h2>
                <div class="admin-tabs">
                    <button id="tab-records" class="tab-btn active" onclick="switchAdminTab('records')">å‡ºå‹¤æ˜ç´°</button>
                    <button id="tab-settings" class="tab-btn" onclick="switchAdminTab('settings')">æ“šé»è¨­å®š</button>
                </div>
            </div>
            
            <div id="admin-tab-records-content">
                <div class="controls-box">
                    <select id="user-filter" class="admin-input" onchange="filterAdminHistory()" style="margin-top:0;">
                        <option value="all">é¡¯ç¤ºæ‰€æœ‰äºº</option>
                    </select>
                </div>
                <div id="admin-list" class="history-list">
                    <p style="text-align: center; color: #bdc3c7; font-size: 14px;">æ•¸æ“šåŒæ­¥ä¸­...</p>
                </div>
            </div>

            <div id="admin-tab-settings-content" style="display:none;">
                <div class="controls-box" style="text-align: left; padding: 15px;">
                    <label style="font-size: 11px; font-weight: bold; color: var(--primary-color);">1. è¨­å®šæ“šé»åç¨±</label>
                    <input type="text" id="set-remark" class="admin-input" placeholder="ä¾‹å¦‚: å°ä¸­æ——è‰¦åº—">
                    
                    <label style="font-size: 11px; font-weight: bold; color: var(--primary-color); margin-top: 10px; display: block;">2. åœ°å€æœå°‹è‡ªå‹•å®šä½</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="search-address" class="admin-input" placeholder="è«‹è¼¸å…¥åœ°å€ (å»ºè­°ç§»é™¤æ¨“å±¤ç´°ç¯€)">
                        <button class="btn" style="width: auto; margin-top: 8px; font-size: 13px; padding: 0 15px;" onclick="searchAddress()">æœå°‹</button>
                    </div>

                    <label style="font-size: 11px; font-weight: bold; color: var(--primary-color); margin-top: 10px; display: block;">3. æª¢è¦–åº§æ¨™èˆ‡èª¿æ•´ç¯„åœ</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="set-lat" class="admin-input" step="any" placeholder="ç·¯åº¦ Lat">
                        <input type="number" id="set-lng" class="admin-input" step="any" placeholder="ç¶“åº¦ Lng">
                    </div>
                    <input type="number" id="set-radius" class="admin-input" placeholder="å®¹è¨±åŠå¾‘ (å…¬å°º, å»ºè­° 200)">
                    
                    <div id="admin-map-preview" class="admin-map-preview">
                        <iframe id="admin-map-iframe" src=""></iframe>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn" style="flex: 1; font-size: 13px; padding: 12px;" onclick="captureCurrentLocation()">æŠ“å–æˆ‘ç›®å‰ä½ç½®</button>
                        <button class="btn" style="flex: 1; font-size: 13px; padding: 12px; background: var(--secondary-color);" onclick="addNewLocation()">æ–°å¢è‡³åˆ—è¡¨</button>
                    </div>
                </div>

                <div class="location-manager-list" id="location-list-ui"></div>
            </div>

            <button class="btn-history" style="width: 100%; margin-top: 25px; text-align: center; font-weight: 800;" onclick="showView('clock')">ç™»å‡ºç®¡ç†æ¨¡å¼</button>
        </div>
        
        <div class="version">ORIGIN CLOUD V3.7 PRO</div>
        <div id="admin-entrance" class="admin-link" onclick="openAdminLoginModal()">ADMIN</div>
    </div>

    <!-- ç®¡ç†å“¡å¯†ç¢¼ -->
    <div id="admin-login-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin: 0; color: var(--primary-color);">ç®¡ç†å“¡é©—è­‰</h3>
            <input type="password" id="admin-password-input" class="admin-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" style="text-align:center; margin: 15px 0;">
            <div class="modal-btns">
                <button class="modal-btn" style="background:#f1f5f9;" onclick="closeAdminLoginModal()">å–æ¶ˆ</button>
                <button class="modal-btn" style="background:var(--primary-color); color:white;" onclick="verifyAdminPassword()">ç™»å…¥</button>
            </div>
        </div>
    </div>

    <!-- è¨»éŠ·ç¢ºèªå½ˆçª— -->
    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin: 0; color: var(--error-color); font-size: 20px;">è¨»éŠ·æ‰“å¡ç´€éŒ„ï¼Ÿ</h3>
            <p style="font-size:14px; color:#64748b; line-height: 1.5; margin-top: 10px;">åˆªé™¤å¾Œè³‡æ–™å°‡ç„¡æ³•æ¢å¾©ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ</p>
            <div class="modal-btns">
                <button class="modal-btn" style="background:#f1f5f9;" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="modal-btn" style="background:var(--error-color); color:white;">ç¢ºå®šè¨»éŠ·</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1CUSE-tou-H_BxfEGg4mxA30HsGF8DWE",
            authDomain: "origin-cloud-clockin.firebaseapp.com",
            projectId: "origin-cloud-clockin",
            storageBucket: "origin-cloud-clockin.firebasestorage.app",
            messagingSenderId: "160594589221",
            appId: "1:160594589221:web:29aad0f9cbeb828d7571cc",
            measurementId: "G-EC0ZQZ47E0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userProfile = null;
        let userCoords = null;
        let allRecords = []; 
        let officeLocations = []; 
        let pendingDeleteId = null;

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        window.showView = function(view) {
            const clockPage = document.getElementById('clock-page');
            const historyPage = document.getElementById('history-page');
            const adminPage = document.getElementById('admin-page');
            const mainCard = document.getElementById('main-card');
            const gpsDisplay = document.getElementById('gps-display');
            const mainMapBox = document.getElementById('main-map-box');

            clockPage.style.display = 'none';
            historyPage.style.display = 'none';
            adminPage.style.display = 'none';
            mainCard.classList.remove('admin-active');

            if (view === 'history') {
                historyPage.style.display = 'block'; fetchHistory();
            } else if (view === 'admin') {
                adminPage.style.display = 'block'; mainCard.classList.add('admin-active'); switchAdminTab('records');
            } else {
                clockPage.style.display = 'block';
                if (userCoords) { gpsDisplay.style.display = 'block'; mainMapBox.style.display = 'block'; }
            }
        };

        window.switchAdminTab = function(tab) {
            const tabRec = document.getElementById('tab-records');
            const tabSet = document.getElementById('tab-settings');
            if (tab === 'records') {
                document.getElementById('admin-tab-records-content').style.display = 'block';
                document.getElementById('admin-tab-settings-content').style.display = 'none';
                tabRec.classList.add('active'); tabSet.classList.remove('active');
                fetchAdminHistory();
            } else {
                document.getElementById('admin-tab-records-content').style.display = 'none';
                document.getElementById('admin-tab-settings-content').style.display = 'block';
                tabRec.classList.remove('active'); tabSet.classList.add('active');
                renderLocationList();
            }
        };

        window.openAdminLoginModal = function() { document.getElementById('admin-login-modal').style.display = 'flex'; };
        window.closeAdminLoginModal = function() { document.getElementById('admin-login-modal').style.display = 'none'; };
        window.verifyAdminPassword = function() {
            if (document.getElementById('admin-password-input').value === "1016") {
                closeAdminLoginModal(); showView('admin');
            } else { alert("å¯†ç¢¼éŒ¯èª¤"); }
        };

        function updateAdminMapPreview(lat, lng) {
            const previewBox = document.getElementById('admin-map-preview');
            const iframe = document.getElementById('admin-map-iframe');
            if (lat && lng) {
                iframe.src = `https://maps.google.com/maps?q=${lat},${lng}&hl=zh-TW&z=17&output=embed`;
                previewBox.style.display = 'block';
            }
        }

        window.captureCurrentLocation = function() {
            if (userCoords) {
                document.getElementById('set-lat').value = userCoords.lat;
                document.getElementById('set-lng').value = userCoords.lng;
                document.getElementById('set-radius').value = 200;
                updateAdminMapPreview(userCoords.lat, userCoords.lng);
            } else { alert("å®šä½ä¸­ï¼Œè«‹ç¨å¾Œ"); }
        };

        window.searchAddress = async function() {
            const addressInput = document.getElementById('search-address').value.trim();
            if (!addressInput) { alert("è«‹è¼¸å…¥åœ°å€"); return; }
            const statusText = document.getElementById('status');
            statusText.innerText = "æ­£åœ¨å®šä½..."; statusText.style.display = "block";
            try {
                let cleanAddress = addressInput.split(/[æ¨“Ffå®¤]/)[0];
                const searchQuery = cleanAddress.includes("å°ç£") ? cleanAddress : "å°ç£ " + cleanAddress;
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=tw&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const lat = data[0].lat; const lng = data[0].lon;
                    document.getElementById('set-lat').value = lat; document.getElementById('set-lng').value = lng;
                    updateAdminMapPreview(lat, lng); statusText.innerText = "æœå°‹æˆåŠŸï¼";
                    setTimeout(() => { if(document.getElementById('admin-page').style.display === 'block') statusText.style.display = 'none'; }, 2500);
                } else {
                    alert("æ‰¾ä¸åˆ°è©²åœ°å€ï¼Œè«‹ç°¡åŒ–åœ°å€å†è©¦ã€‚"); statusText.innerText = "";
                }
            } catch (e) { alert("æœå°‹æœå‹™ä¸å¯ç”¨"); statusText.innerText = ""; }
        };

        window.addNewLocation = async function() {
            const remark = document.getElementById('set-remark').value;
            const lat = parseFloat(document.getElementById('set-lat').value);
            const lng = parseFloat(document.getElementById('set-lng').value);
            const radius = parseInt(document.getElementById('set-radius').value);
            if (!remark || isNaN(lat) || isNaN(lng) || isNaN(radius)) { alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Š"); return; }
            const newLoc = { id: Date.now().toString(), remark, lat, lng, radius };
            officeLocations.push(newLoc);
            try {
                await setDoc(doc(db, "tenants/Corin_Beauty/settings", "config"), { locations: officeLocations });
                renderLocationList();
                document.getElementById('set-remark').value = ""; document.getElementById('search-address').value = "";
                document.getElementById('set-lat').value = ""; document.getElementById('set-lng').value = "";
                document.getElementById('set-radius').value = ""; document.getElementById('admin-map-preview').style.display = 'none';
                alert("æ“šé»å·²æ–°å¢");
            } catch (e) { alert("å„²å­˜å¤±æ•—"); }
        };

        window.deleteLocation = async function(id) {
            officeLocations = officeLocations.filter(l => l.id !== id);
            await setDoc(doc(db, "tenants/Corin_Beauty/settings", "config"), { locations: officeLocations });
            renderLocationList();
        };

        function renderLocationList() {
            const container = document.getElementById('location-list-ui');
            if (officeLocations.length === 0) { container.innerHTML = '<p style="font-size:12px; color:#ccc; text-align:center; padding: 20px;">å°šç„¡è¨­å®šæ“šé»</p>'; return; }
            container.innerHTML = officeLocations.map(l => `
                <div class="location-card">
                    <div class="loc-info">
                        <span class="loc-name">${l.remark}</span>
                        <span class="loc-detail">ğŸ“ ${parseFloat(l.lat).toFixed(4)}, ${parseFloat(l.lng).toFixed(4)}</span>
                        <div class="loc-radius-pill">ç¯„åœ ${l.radius}m</div>
                    </div>
                    <span class="btn-loc-del" onclick="deleteLocation('${l.id}')">åˆªé™¤</span>
                </div>
            `).join('');
        }

        window.openDeleteModal = function(id) { pendingDeleteId = id; document.getElementById('delete-modal').style.display = 'flex'; };
        window.closeDeleteModal = function() { pendingDeleteId = null; document.getElementById('delete-modal').style.display = 'none'; };

        document.getElementById('modal-confirm-btn').onclick = async function() {
            if (!pendingDeleteId) return;
            try {
                if (!auth.currentUser) await signInAnonymously(auth);
                await deleteDoc(doc(db, "tenants/Corin_Beauty/checkins", pendingDeleteId));
                closeDeleteModal(); fetchHistory();
            } catch (e) { alert("è¨»éŠ·å¤±æ•—"); }
        };

        async function initSystem() {
            const statusText = document.getElementById('status');
            const gpsDisplay = document.getElementById('gps-display');
            const mainMapBox = document.getElementById('main-map-box');
            const mainMapIframe = document.getElementById('main-map-iframe');
            try {
                showView('clock'); await liff.init({ liffId: "2008997688-9iB69K6M" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                userProfile = await liff.getProfile(); await signInAnonymously(auth);
                const configSnap = await getDoc(doc(db, "tenants/Corin_Beauty/settings", "config"));
                if (configSnap.exists()) officeLocations = configSnap.data().locations || [];
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    mainMapIframe.src = `https://maps.google.com/maps?q=${userCoords.lat},${userCoords.lng}&hl=zh-TW&z=17&output=embed`;
                    mainMapBox.style.display = 'block'; gpsDisplay.style.display = "block";
                    gpsDisplay.innerText = `ğŸ“ ç›®å‰ä½ç½®: ${userCoords.lat.toFixed(4)}, ${userCoords.lng.toFixed(4)}`;
                    document.getElementById('loader').style.display = "none";
                    document.getElementById('btn-container').style.display = "flex";
                    statusText.innerText = "å®šä½æˆåŠŸï¼Œå¯é–‹å§‹æ‰“å¡";
                }, (err) => { statusText.innerText = "å®šä½å¤±æ•—ï¼Œè«‹é–‹å•Ÿ GPS"; }, { enableHighAccuracy: true, timeout: 10000 });
            } catch (err) { statusText.innerText = "é€£ç·šä¸­æ–·"; }
        }

        window.submitCheckIn = async function(type) {
            if (!userProfile || !userCoords) return;
            let allowClockIn = false; let currentOfficeName = "";
            if (officeLocations.length > 0) {
                officeLocations.forEach(loc => {
                    const dist = getDistance(userCoords.lat, userCoords.lng, loc.lat, loc.lng);
                    if (dist <= loc.radius) { allowClockIn = true; currentOfficeName = loc.remark; }
                });
            } else { allowClockIn = true; currentOfficeName = "æœªè¨­æ“šé»"; }

            if (!allowClockIn) {
                document.getElementById('status').innerText = `ä¸åœ¨æ‰“å¡ç¯„åœå…§ï¼Œç„¡æ³•æ‰“å¡`;
                document.getElementById('status').style.color = "var(--error-color)"; return;
            }

            document.getElementById('btn-container').style.display = "none";
            document.getElementById('main-map-box').style.display = "none";
            document.getElementById('gps-display').style.display = "none";
            document.getElementById('loader').style.display = "block";
            try {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                await addDoc(collection(db, "tenants/Corin_Beauty/checkins"), {
                    userId: userProfile.userId, userName: userProfile.displayName,
                    locationName: currentOfficeName, lat: userCoords.lat, lng: userCoords.lng, 
                    timestamp: serverTimestamp(), type: type, client: "V3.7"
                });
                document.getElementById('loader').style.display = "none";
                document.getElementById('success').style.display = "block";
                document.getElementById('status').innerText = `[${timeStr}] ${type}æˆåŠŸï¼`;
                document.getElementById('status').style.color = "var(--primary-color)";
                setTimeout(() => liff.closeWindow(), 2500);
            } catch (e) { alert("æäº¤å¤±æ•—"); }
        };

        async function fetchHistory() {
            const listContainer = document.getElementById('history-list');
            try {
                const querySnapshot = await getDocs(collection(db, "tenants/Corin_Beauty/checkins"));
                let records = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data(); if (data.userId === userProfile.userId) records.push({ ...data, id: doc.id });
                });
                renderHistoryList(records, listContainer, false);
            } catch (e) { listContainer.innerHTML = '<p>è®€å–å¤±æ•—</p>'; }
        }

        async function fetchAdminHistory() {
            const listContainer = document.getElementById('admin-list');
            const filterSelect = document.getElementById('user-filter');
            try {
                const querySnapshot = await getDocs(collection(db, "tenants/Corin_Beauty/checkins"));
                allRecords = []; let users = new Set();
                querySnapshot.forEach((doc) => {
                    const data = doc.data(); allRecords.push({ ...data, id: doc.id });
                    if (data.userName) users.add(data.userName);
                });
                filterSelect.innerHTML = '<option value="all">é¡¯ç¤ºæ‰€æœ‰äºº</option>';
                Array.from(users).sort().forEach(name => {
                    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; filterSelect.appendChild(opt);
                });
                filterAdminHistory();
            } catch (e) { listContainer.innerHTML = '<p>åŠ è¼‰å¤±æ•—</p>'; }
        }

        window.filterAdminHistory = function() {
            let filtered = document.getElementById('user-filter').value === "all" ? allRecords : allRecords.filter(r => r.userName === document.getElementById('user-filter').value);
            renderHistoryList(filtered, document.getElementById('admin-list'), true);
        };

        // æ ¸å¿ƒæ’åºä¿®æ­£ï¼šç¢ºä¿æœ€æ–°ç´€éŒ„æ°¸é åœ¨æœ€ä¸Šæ–¹
        function renderHistoryList(records, container, isAdmin) {
            let groups = {};
            records.forEach(rec => {
                if (!rec.timestamp) return;
                const d = rec.timestamp.toDate(); 
                const dateKey = d.toLocaleDateString('zh-TW');
                const userKey = rec.userName || 'æœªçŸ¥ç”¨æˆ¶';
                const key = `${dateKey}_${userKey}`;

                if (!groups[key]) {
                    groups[key] = { 
                        date: dateKey, 
                        user: userKey, 
                        items: [], 
                        totalMinutes: 0,
                        latestTimestamp: 0 // ç”¨æ–¼çµ„é–“æ’åº
                    };
                }
                groups[key].items.push(rec);
                // æ›´æ–°è©²çµ„æœ€æ–°çš„ç§’æ•¸ï¼Œç¢ºä¿å¾ŒçºŒçµ„é–“æ’åº
                if (rec.timestamp.seconds > groups[key].latestTimestamp) {
                    groups[key].latestTimestamp = rec.timestamp.seconds;
                }
            });

            // è¨ˆç®—ç•¶æ—¥ç¸½å·¥æ™‚
            Object.values(groups).forEach(g => {
                const ins = g.items.filter(i => i.type === 'ç°½åˆ°'); 
                const outs = g.items.filter(i => i.type === 'ç°½é€€');
                if (ins.length && outs.length) {
                    const firstIn = Math.min(...ins.map(i => i.timestamp.toDate()));
                    const lastOut = Math.max(...outs.map(i => i.timestamp.toDate()));
                    if (lastOut > firstIn) g.totalMinutes = (lastOut - firstIn) / (1000 * 60);
                }
            });

            // ä¿®æ­£ï¼šæŒ‰ã€Œæœ€æ–°æ‰“å¡æ™‚é–“ã€ç”±å¤§åˆ°å°æ’åºæ‰€æœ‰ç¾¤çµ„
            const sortedGroups = Object.values(groups).sort((a, b) => b.latestTimestamp - a.latestTimestamp);

            if (!sortedGroups.length) { container.innerHTML = '<p style="text-align:center; color:#ccc; margin-top:20px;">å°šç„¡ç´€éŒ„</p>'; return; }

            container.innerHTML = sortedGroups.map(g => {
                // å…§éƒ¨ç´°é …æ’åºï¼šç¢ºä¿åŒä¸€å¤©å…§æœ€æ–°æ‰“å¡çš„ä¹Ÿåœ¨ä¸Šæ–¹
                const itemsHtml = g.items.sort((a,b) => b.timestamp.seconds - a.timestamp.seconds).map(rec => {
                    const timeStr = rec.timestamp.toDate().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                    return `
                        <div class="history-item ${rec.type === 'ç°½åˆ°' ? 'in' : 'out'}">
                            <div class="item-info">
                                ${isAdmin ? `<span class="item-user">${rec.userName}</span>` : ''}
                                <span class="item-type">${rec.type}</span>
                                <span class="item-date">${g.date}</span>
                                <div class="item-loc-name">ğŸ“ ${rec.locationName || 'æœªçŸ¥æ“šé»'}</div>
                            </div>
                            <div class="item-time-row">
                                <div class="item-time">${timeStr}</div>
                                ${!isAdmin ? `<button class="btn-delete" onclick="openDeleteModal('${rec.id}')">è¨»éŠ·</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                const durationHtml = g.totalMinutes > 0 ? `<div class="daily-summary"><span>ğŸ•’ å–®æ—¥ç¸½å·¥æ™‚</span><span>${Math.floor(g.totalMinutes/60)} å°æ™‚ ${Math.round(g.totalMinutes%60)} åˆ†</span></div>` : '';
                return itemsHtml + durationHtml;
            }).join('');
        }

        window.onload = initSystem;
    </script>
</body>
</html>
